@Entry
@Component
struct MoodApp {
  @State moods: Array<Mood> = []
  @State newMoodContent: string = ''
  @State showAddDialog: boolean = false
  @State selectedMoodIcon: string = 'neutral'
  @State selectedMoodName: string = 'ä¸€èˆ¬'
  private nextId: number = 1

  // å¯ç”¨çš„å¿ƒæƒ…çŠ¶æ€
  moodIcons: Array<MoodIcon> = [
    { id: 'happy', name: 'å¼€å¿ƒ', color: '#FFD700', icon: 'ğŸ˜Š' },
    { id: 'excited', name: 'å…´å¥‹', color: '#FF6B6B', icon: 'ğŸ¤©' },
    { id: 'neutral', name: 'ä¸€èˆ¬', color: '#4D96FF', icon: 'ğŸ˜' },
    { id: 'sad', name: 'éš¾è¿‡', color: '#6BCB77', icon: 'ğŸ˜”' },
    { id: 'angry', name: 'ç”Ÿæ°”', color: '#FF8066', icon: 'ğŸ˜ ' },
    { id: 'tired', name: 'ç–²æƒ«', color: '#9C51B6', icon: 'ğŸ˜©' }
  ]

  // æ·»åŠ æ–°å¿ƒæƒ…è®°å½•
  addMood() {
    if (this.newMoodContent.trim() !== '') {
      const currentTime = new Date()
      const formattedDate = `${currentTime.getFullYear()}-${(currentTime.getMonth() + 1).toString().padStart(2, '0')}-${currentTime.getDate().toString().padStart(2, '0')}`
      const formattedTime = `${currentTime.getHours().toString().padStart(2, '0')}:${currentTime.getMinutes().toString().padStart(2, '0')}`

      this.moods.unshift({
        id: this.nextId++,
        content: this.newMoodContent,
        date: formattedDate,
        time: formattedTime,
        moodType: this.selectedMoodIcon,
        moodName: this.selectedMoodName
      })
      this.newMoodContent = ''
      this.showAddDialog = false
    }
  }

  // åˆ é™¤å¿ƒæƒ…è®°å½•
  deleteMood(id: number) {
    this.moods = this.moods.filter(mood => mood.id !== id)
  }

  // è·å–å¿ƒæƒ…å›¾æ ‡
  getMoodIcon(moodType: string): string {
    const mood = this.moodIcons.find(icon => icon.id === moodType)
    return mood ? mood.icon : 'â“'
  }

  // è·å–å¿ƒæƒ…é¢œè‰²
  getMoodColor(moodType: string): string {
    const mood = this.moodIcons.find(icon => icon.id === moodType)
    return mood ? mood.color : '#CCCCCC'
  }

  build() {
    // ä½¿ç”¨Stackä½œä¸ºæ ¹å®¹å™¨ï¼Œè§£å†³å¤šä¸ªæ ¹èŠ‚ç‚¹é—®é¢˜
    Stack() {
      // ä¸»åº”ç”¨å†…å®¹
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜æ 
        Column() {
          Text('å¿ƒæƒ…è®°å½•')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .margin({ top: 20 })

          Text('è®°å½•ä½ çš„æ¯æ—¥å¿ƒæƒ…çŠ¶æ€')
            .fontSize(14)
            .fontColor('#E0E0E0')
            .margin({ top: 4, bottom: 16 })
        }
        .width('100%')
        .backgroundColor('#6A5ACD')
        .alignItems(HorizontalAlign.Center)
        .padding(10)
        .shadow({ radius: 4, color: '#20000000', offsetX: 0, offsetY: 2 })

        // æ·»åŠ å¿ƒæƒ…æŒ‰é’®
        Button('+ æ·»åŠ ä»Šæ—¥å¿ƒæƒ…')
          .width(200)
          .height(50)
          .margin({ top: 20 })
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor('#FF6B6B')
          .borderRadius(25)
          .onClick(() => {
            this.showAddDialog = true
          })

        // å¿ƒæƒ…è®°å½•åˆ—è¡¨
        if (this.moods.length > 0) {
          Text('å¿ƒæƒ…å†å²è®°å½•')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
            .margin({ top: 30, left: 20, right: 20 })
            .alignSelf(ItemAlign.Start)

          List({ space: 16 }) {
            ForEach(this.moods, (mood: Mood) => {
              ListItem() {
                // å¿ƒæƒ…å¡ç‰‡
                Row() {
                  // å¿ƒæƒ…å›¾æ ‡
                  Column() {
                    Text(this.getMoodIcon(mood.moodType))
                      .fontSize(28)
                      .fontWeight(FontWeight.Bold)
                  }
                  .width(60)
                  .height(60)
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .backgroundColor(this.getMoodColor(mood.moodType))
                  .borderRadius(10)
                  .margin({ right: 16 })

                  // å¿ƒæƒ…è¯¦æƒ…
                  Column() {
                    Row() {
                      Text(mood.moodName)
                        .fontSize(16)
                        .fontColor('#FFFFFF')
                        .backgroundColor(this.getMoodColor(mood.moodType))
                        .borderRadius(4)
                        .padding({ left: 8, right: 8, top: 3, bottom: 3 })

                      Blank()

                      Text(mood.date)
                        .fontSize(14)
                        .fontColor('#888888')
                    }
                    .width('100%')
                    .margin({ bottom: 8 })

                    Text(mood.content)
                      .fontSize(16)
                      .fontColor('#333333')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .margin({ bottom: 8 })

                    Text(mood.time)
                      .fontSize(12)
                      .fontColor('#888888')
                      .alignSelf(ItemAlign.End)
                  }
                  .layoutWeight(1)
                }
                .padding(16)
                .borderRadius(12)
                .backgroundColor('#FFFFFF')
                .width('100%')
                .shadow({ radius: 2, color: '#10000000', offsetX: 0, offsetY: 1 })
              }
              .swipeAction({ end: this.DeleteButton(mood.id) })
            }, (mood: Mood) => mood.id.toString())
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 10 })
          .margin({ top: 10 })
        } else {
          // ç©ºçŠ¶æ€æç¤º
          Column() {
            // Image($r('app.media.tried'))
            //   .width(120)
            //   .height(120)
            //   .margin({ bottom: 20 })
            Text('æš‚æ— å¿ƒæƒ…è®°å½•')
              .fontSize(18)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            Text('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ä½ çš„ä»Šæ—¥å¿ƒæƒ…')
              .fontSize(14)
              .fontColor('#999999')
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F7FA')

      // æ·»åŠ å¿ƒæƒ…å¯¹è¯æ¡† - æ”¾åœ¨Stackä¸­ä½œä¸ºè¦†ç›–å±‚
      if (this.showAddDialog) {
        Column() {
          Column() {
            Text('æ·»åŠ ä»Šæ—¥å¿ƒæƒ…')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 16 })

            // å¿ƒæƒ…çŠ¶æ€é€‰æ‹©
            Text('é€‰æ‹©å¿ƒæƒ…çŠ¶æ€')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ bottom: 10 })
              .alignSelf(ItemAlign.Start)

            // å¿ƒæƒ…å›¾æ ‡é€‰æ‹©å™¨
            Grid() {
              ForEach(this.moodIcons, (icon: MoodIcon) => {
                GridItem() {
                  Column() {
                    Text(icon.icon)
                      .fontSize(28)
                      .margin({ bottom: 5 })
                    Text(icon.name)
                      .fontSize(12)
                      .fontColor(this.selectedMoodIcon === icon.id ? '#FFFFFF' : '#333333')
                  }
                  .padding(10)
                  .borderRadius(10)
                  .backgroundColor(this.selectedMoodIcon === icon.id ? icon.color : '#F0F0F0')
                  .onClick(() => {
                    this.selectedMoodIcon = icon.id
                    this.selectedMoodName = icon.name
                  })
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr')
            .rowsTemplate('1fr 1fr')
            .columnsGap(12)
            .rowsGap(12)
            .margin({ bottom: 20 })
            .height(160)

            // å¿ƒæƒ…æè¿°è¾“å…¥
            Text('å¿ƒæƒ…æè¿°')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ bottom: 10 })
              .alignSelf(ItemAlign.Start)

            TextInput({ placeholder: 'æè¿°ä½ çš„å¿ƒæƒ…...', text: this.newMoodContent })
              .onChange((value: string) => {
                this.newMoodContent = value
              })
              .height(100)
              .width('100%')
              .padding(10)
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .border({ width: 1, color: '#E0E0E0' })

            // æ“ä½œæŒ‰é’®
            Row() {
              Button('å–æ¶ˆ')
                .width(120)
                .height(40)
                .fontSize(16)
                .fontColor('#666666')
                .backgroundColor('#EEEEEE')
                .borderRadius(20)
                .onClick(() => {
                  this.showAddDialog = false
                  this.newMoodContent = ''
                })

              Button('æ·»åŠ ')
                .width(120)
                .height(40)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor('#6A5ACD')
                .borderRadius(20)
                .onClick(() => {
                  this.addMood()
                })
            }
            .margin({ top: 20 })
            .justifyContent(FlexAlign.SpaceBetween)
            .width('100%')
          }
          .padding(24)
          .width('90%')
          // .maxWidth(400)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#80000000')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showAddDialog = false
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  // åˆ é™¤æŒ‰é’®ç»„ä»¶
  @Builder DeleteButton(id: number) {
    Button() {
      Image($r('app.media.startIcon'))
        .width(20)
        .height(20)
    }
    .width(60)
    .height('100%')
    .backgroundColor('#FF5252')
    .borderRadius(12)
    .onClick(() => {
      this.deleteMood(id)
    })
  }
}

// å¿ƒæƒ…æ•°æ®ç»“æ„
interface Mood {
  id: number;
  content: string;
  date: string;
  time: string;
  moodType: string;
  moodName: string;
}

interface MoodIcon {
  id: string;
  name: string;
  color: string;
  icon: string;
}
